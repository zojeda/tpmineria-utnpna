---
title: "TPMineria"
author: "Zacarías F. Ojeda"
date: "8/25/2018"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
if(!require("readr")) install.packages("readr")
library(readr)
if(!require("ggplot2")) install.packages("ggplot2")
library(ggplot2)
if(!require("dplyr")) install.packages("dplyr")
library(dplyr)
if(!require("lubridate")) install.packages("lubridate")
library(lubridate)
if(!require("arules")) install.packages("arules")
library("arules")
```

Cargamos los datasets originales 

```{r, echo=TRUE}
sentencias_1c <- read_csv("./sentencias_1c.csv")
organismos <- read_csv("./organismos.csv")
```
Calcula duracion como Fecha de Resolucion - Fecha de inicio

```{r}
sentencias_1c <- sentencias_1c %>% 
  mutate(finicio = lubridate::dmy(finicio)) %>% 
  mutate(fres = lubridate::dmy(fres)) %>% 
  mutate(duracion = fres - finicio)

```
Eliminamos filas que tienen datos invalidos de fecha (datos nulos o futuros por error de tipeo)
Reemplazamos los datos NA de reccap por cero.

```{r}
sentencias_1c <- sentencias_1c[-c(which(is.na(sentencias_1c$finicio))), ]
sentencias_1c <- sentencias_1c[-c(which(is.na(sentencias_1c$fres))), ]
sentencias_1c <- sentencias_1c[-c(which(sentencias_1c$fres > '2018-09-01')), ]
sentencias_1c <- sentencias_1c[-c(which(sentencias_1c$finicio > '2018-09-01')), ]

sentencias_1c$reccap[is.na(sentencias_1c$reccap)] <- 0

```
Calcula la media de la demora por cada tipo de proceso (tproc), y
se clasifica en demorado / no demorado si duracion es mayor a media de tproc.

```{r}
duracion_media = sentencias_1c %>% 
  group_by(tproc) %>% 
  summarise(mediana_duracion=median(duracion))

sentencias_1c <- sentencias_1c %>% 
  left_join(duracion_media) %>% 
  mutate(demorado = duracion > mediana_duracion)

```
Agrega datos de organismos para tenerlos separados por columna, actualmente se encuentra en columna iep.

```{r}
organismos <- organismos %>% 
  select(organismo, circunscripcion, localidad, materia)

sentencias_1c <- sentencias_1c %>% 
  left_join(organismos, by = c('iep'='organismo'))

```


Exploremos la variable capital reclamado para definir los rangos

```{r}
histograma <- sentencias_1c %>% 
  ggplot() +
  geom_histogram(aes(x=log(reccap)))

histograma
```

Calculamos los cuartiles para ver si nos sirven para parametrizar (reccap)

```{r}
print('1º Curtil:')
quantile(pull(sentencias_1c[,'reccap']),.25)
print('2º Curtil:')
quantile(pull(sentencias_1c[,'reccap']),.50)
print('3º Curtil:')
quantile(pull(sentencias_1c[,'reccap']),.75)

#View(sentencias_1c)
```
Como dos de los curtiles son cero, elimino los ceros y vuelvo a calcular los cuartiles.

```{r}
#reccap_not_cero <- which(sentencias_1c$reccap != 0)

print('1º Curtil:')
quantile(which(sentencias_1c$reccap != 0),.25)
print('2º Curtil:')
quantile(which(sentencias_1c$reccap != 0),.50)
print('3º Curtil:')
quantile(which(sentencias_1c$reccap != 0),.75)

capmedio <- mean(pull(sentencias_1c[,'reccap']))

sentencias_1c <- sentencias_1c %>% 
  mutate(reccap_0 = reccap == 0) %>% 
  mutate(reccap_1 = (reccap < quantile(which(sentencias_1c$reccap != 0),.25)) & (reccap!=0)) %>% 
  mutate(reccap_2 = (reccap >= quantile(which(sentencias_1c$reccap != 0),.25)) & (reccap < quantile(which(sentencias_1c$reccap != 0),.50))) %>% 
  mutate(reccap_3 = (reccap >= quantile(which(sentencias_1c$reccap != 0),.50)) & (reccap < quantile(which(sentencias_1c$reccap != 0),.75))) %>% 
  mutate(reccap_4 = (reccap >= quantile(which(sentencias_1c$reccap != 0),.75))) 

```

Separo la columna justiciables en 4 rangos para poder aplicar apriori.

```{r}

sentencias_1c <- sentencias_1c %>% 
  mutate(justiciables0_1 = justiciables < 2) %>% 
  mutate(justiciables2_3 = (justiciables > 1) & (justiciables < 4)) %>% 
  mutate(justiciables4_5 = (justiciables > 3) & (justiciables < 6)) %>% 
  mutate(justiciables6_7 = (justiciables > 5) & (justiciables < 8)) %>% 
  mutate(justiciables8_9 = (justiciables > 7) & (justiciables < 10)) %>% 
  mutate(justiciables10_N = justiciables > 9)


```

Separamos Localidad y Circunscripcion en columnas.

```{r}
sentencias_1c <- sentencias_1c %>% 
  mutate(localidad = as.factor(localidad))
```

Separo matria en columnas

```{r}
sentencias_1c <- sentencias_1c %>% 
  mutate(materia = as.factor(materia))
```

```{r}
sentencias_1c <- sentencias_1c %>% 
  mutate(tproc = as.factor(tproc)) 
```


Tomo las columnas tipo booleanos y aplico Apriori.

```{r}

sentencias_bool <- select(sentencias_1c, -nro, -as, -ccon, -finicio, -fres, -fdesp, -fvenc1, -fvenc2, -tres, -mat, -justiciables, -reccap, -iep, -duracion, -mediana_duracion, -circunscripcion)

rules <- apriori(sentencias_bool, parameter = list(supp=0.01, conf=0.7, minlen=2), appearance = list(rhs="demorado"))
summary(rules)
inspect(rules[1:8])

top.confidence <- sort(rules, decreasing = TRUE, na.last = NA, by = "confidence")
inspect(top.confidence[1:8])

top.support <- sort(rules, decreasing = TRUE, na.last = NA, by = "support")
inspect(top.support[1:8])


```


```{r}
library(arulesViz)
plot(rules, method = "grouped")
```

